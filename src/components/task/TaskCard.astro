---
// TaskCard — displays a task summary with status badge, priority indicator, tags, and overdue styling
// Used in Backlog table rows, Kanban cards, etc.
// Client-side JS handles inline editing of status/priority
---
<div class="task-card" data-task-id="" id="task-card-template" style="display:none">
  <div class="task-card-header">
    <span class="priority-indicator"></span>
    <span class="task-title"></span>
    <span class="status-badge"></span>
  </div>
  <div class="task-card-meta">
    <span class="task-dates"></span>
    <span class="task-tags"></span>
  </div>
</div>

<script>
  import type { Task, Status, Priority } from '../../lib/types.ts';
  import { STATUS_LABELS, PRIORITY_LABELS, VALID_TRANSITIONS } from '../../lib/types.ts';

  /** Check if a task is overdue */
  function isOverdue(task: Task): boolean {
    if (!task.end) return false;
    if (task.status === 'done' || task.status === 'archived') return false;
    const today = new Date().toISOString().split('T')[0];
    return task.end < today;
  }

  /** Render a task card into a container element */
  export function renderTaskCard(task: Task, container: HTMLElement): HTMLElement {
    const card = document.createElement('div');
    card.className = `task-card${isOverdue(task) ? ' task--overdue' : ''}`;
    card.dataset.taskId = task.id;
    card.setAttribute('draggable', 'true');

    card.innerHTML = `
      <div class="task-card-header">
        <span class="priority-indicator priority-indicator--${task.priority}" title="${PRIORITY_LABELS[task.priority]}"></span>
        <span class="task-title">${escapeHtml(task.title)}</span>
        <select class="select status-select" data-task-id="${task.id}" data-field="status">
          ${buildStatusOptions(task.status)}
        </select>
      </div>
      <div class="task-card-meta">
        <span class="task-dates">${task.start}${task.end ? ` → ${task.end}` : ''}</span>
        <select class="select priority-select" data-task-id="${task.id}" data-field="priority">
          ${buildPriorityOptions(task.priority)}
        </select>
        <span class="task-tags">${task.tags.map(t => `<span class="tag">${escapeHtml(t)}</span>`).join(' ')}</span>
      </div>
    `;

    container.appendChild(card);
    return card;
  }

  function buildStatusOptions(current: Status): string {
    const allowed = [current, ...VALID_TRANSITIONS[current]];
    return allowed.map(s =>
      `<option value="${s}"${s === current ? ' selected' : ''}>${STATUS_LABELS[s]}</option>`
    ).join('');
  }

  function buildPriorityOptions(current: Priority): string {
    const priorities: Priority[] = ['p0', 'p1', 'p2', 'p3'];
    return priorities.map(p =>
      `<option value="${p}"${p === current ? ' selected' : ''}>${PRIORITY_LABELS[p]}</option>`
    ).join('');
  }

  function escapeHtml(s: string): string {
    const div = document.createElement('div');
    div.textContent = s;
    return div.innerHTML;
  }

  // Expose for use by other scripts
  (window as any).renderTaskCard = renderTaskCard;
</script>

<style>
  .task-card {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
    padding: var(--spacing-sm) var(--spacing-md);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    background: var(--color-bg);
    cursor: pointer;
    transition: box-shadow var(--transition-fast);
  }
  .task-card:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  }
  .task-card-header {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
  }
  .task-title {
    flex: 1;
    font-weight: 500;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .task-card-meta {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
  }
  .task-dates {
    white-space: nowrap;
  }
  .task-tags {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
  }
  .status-select, .priority-select {
    font-size: var(--font-size-sm);
    padding: 1px 4px;
    border: 1px solid transparent;
    background: transparent;
    cursor: pointer;
    border-radius: var(--radius-sm);
  }
  .status-select:hover, .priority-select:hover {
    border-color: var(--color-border);
  }
</style>
