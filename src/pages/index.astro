---
import Header from '../components/layout/Header.astro';
import Sidebar from '../components/layout/Sidebar.astro';
import ViewSwitcher from '../components/layout/ViewSwitcher.astro';
import FilterBar from '../components/common/FilterBar.astro';
import SearchBox from '../components/common/SearchBox.astro';
import TaskForm from '../components/task/TaskForm.astro';
import TaskDetail from '../components/task/TaskDetail.astro';
import TaskCard from '../components/task/TaskCard.astro';
import BacklogView from '../components/views/BacklogView.astro';
import KanbanView from '../components/views/KanbanView.astro';
import GanttView from '../components/views/GanttView.astro';
import '../styles/global.css';
---
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Planner</title>
</head>
<body>
  <div class="app-layout">
    <Header>
      <ViewSwitcher slot="view-switcher" />
      <div slot="actions" class="header-actions">
        <SearchBox />
        <button class="btn btn--primary" id="btn-new-task" title="New task (N)">+ New Task</button>
      </div>
    </Header>
    <Sidebar />
    <main class="app-main" id="app-main">
      <FilterBar />
      <div id="view-backlog" class="view-container"><BacklogView /></div>
      <div id="view-kanban" class="view-container" style="display:none"><KanbanView /></div>
      <div id="view-gantt" class="view-container" style="display:none"><GanttView /></div>
      <!-- Task form modal (hidden by default) -->
      <div class="modal-overlay" id="task-form-overlay" style="display:none">
        <div class="modal" id="task-form-modal">
          <TaskForm />
        </div>
      </div>
      <!-- Task detail panel (hidden by default) -->
      <div class="modal-overlay" id="task-detail-overlay" style="display:none">
        <div class="modal" id="task-detail-modal">
          <TaskDetail />
        </div>
      </div>
      <!-- Delete confirmation dialog -->
      <div class="modal-overlay" id="delete-confirm-overlay" style="display:none">
        <div class="modal" id="delete-confirm-modal">
          <h3>Delete Task</h3>
          <p id="delete-confirm-text">Are you sure you want to delete this task?</p>
          <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:16px;">
            <button class="btn" id="btn-cancel-delete">Cancel</button>
            <button class="btn btn--primary" id="btn-confirm-delete" style="background:var(--color-priority-p0);border-color:var(--color-priority-p0);">Delete</button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    import { initKeyboardShortcuts } from '../scripts/keyboard.ts';
    import type { Task, Status, Priority } from '../lib/types.ts';
    import { VALID_TRANSITIONS, STATUS_LABELS, PRIORITY_LABELS } from '../lib/types.ts';

    initKeyboardShortcuts();

    // ========================================
    // Task data store (client-side in-memory)
    // ========================================
    let tasks: Task[] = [];
    let editingTaskId: string | null = null;
    let deletingTaskId: string | null = null;

    // Load tasks from server (Astro API endpoint or pre-rendered data)
    // For now, tasks are managed client-side; server integration comes with US5
    function getTasks(): Task[] { return tasks; }

    function addTask(task: Task): void {
      tasks.push(task);
      refreshViews();
    }

    function updateTaskInStore(id: string, updates: Partial<Task>): void {
      const idx = tasks.findIndex(t => t.id === id);
      if (idx >= 0) {
        tasks[idx] = { ...tasks[idx], ...updates, updated: new Date().toISOString() };
        refreshViews();
      }
    }

    function removeTaskFromStore(id: string): void {
      tasks = tasks.filter(t => t.id !== id);
      refreshViews();
    }

    function isValidTransition(from: Status, to: Status): boolean {
      if (from === to) return true;
      return VALID_TRANSITIONS[from]?.includes(to) ?? false;
    }

    // ========================================
    // View Switching
    // ========================================
    const views = ['backlog', 'kanban', 'gantt'] as const;
    let currentView = 'backlog';

    function showView(view: string) {
      currentView = view;
      for (const v of views) {
        const el = document.getElementById(`view-${v}`);
        if (el) el.style.display = v === view ? '' : 'none';
      }
      document.querySelectorAll('#view-switcher .view-btn').forEach((btn) => {
        btn.classList.toggle('active', (btn as HTMLElement).dataset.view === view);
      });
      refreshViews();
    }

    document.getElementById('view-switcher')?.addEventListener('click', (e) => {
      const btn = (e.target as HTMLElement).closest('.view-btn') as HTMLElement | null;
      if (btn?.dataset.view) showView(btn.dataset.view);
    });

    document.addEventListener('planner:switch-view', ((e: CustomEvent) => {
      showView(e.detail.view);
    }) as EventListener);

    // ========================================
    // Task Form — Create & Edit (T023, T024)
    // ========================================
    const formOverlay = document.getElementById('task-form-overlay') as HTMLElement;
    const formHeading = document.getElementById('task-form-heading') as HTMLElement;
    const form = document.getElementById('task-form') as HTMLFormElement;
    const formId = document.getElementById('task-form-id') as HTMLInputElement;
    const formTitle = document.getElementById('task-form-title') as HTMLInputElement;
    const formDesc = document.getElementById('task-form-description') as HTMLTextAreaElement;
    const formStatus = document.getElementById('task-form-status') as HTMLSelectElement;
    const formPriority = document.getElementById('task-form-priority') as HTMLSelectElement;
    const formStart = document.getElementById('task-form-start') as HTMLInputElement;
    const formEnd = document.getElementById('task-form-end') as HTMLInputElement;
    const formTags = document.getElementById('task-form-tags') as HTMLInputElement;
    const formSubmitBtn = document.getElementById('task-form-submit') as HTMLButtonElement;

    function openNewTaskForm() {
      editingTaskId = null;
      formHeading.textContent = 'New Task';
      formSubmitBtn.textContent = 'Create Task';
      formId.value = '';
      formTitle.value = '';
      formDesc.value = '';
      formStatus.value = 'backlog';
      formPriority.value = 'p3';
      formStart.value = new Date().toISOString().split('T')[0];
      formEnd.value = '';
      formTags.value = '';
      formOverlay.style.display = '';
      formTitle.focus();
    }

    function openEditTaskForm(task: Task) {
      editingTaskId = task.id;
      formHeading.textContent = 'Edit Task';
      formSubmitBtn.textContent = 'Save Changes';
      formId.value = task.id;
      formTitle.value = task.title;
      formDesc.value = task.description;
      formStatus.value = task.status;
      formPriority.value = task.priority;
      formStart.value = task.start;
      formEnd.value = task.end;
      formTags.value = task.tags.join(', ');
      formOverlay.style.display = '';
      formTitle.focus();
    }

    function closeForm() {
      formOverlay.style.display = 'none';
      editingTaskId = null;
    }

    // New task from keyboard shortcut or button
    document.addEventListener('planner:new-task', () => openNewTaskForm());
    document.getElementById('btn-new-task')?.addEventListener('click', () => openNewTaskForm());
    document.getElementById('task-form-cancel')?.addEventListener('click', closeForm);

    // Form submit — create or update
    form?.addEventListener('submit', (e) => {
      e.preventDefault();
      const title = formTitle.value.trim();
      if (!title) return;

      const taskData = {
        title,
        description: formDesc.value,
        status: formStatus.value as Status,
        priority: formPriority.value as Priority,
        start: formStart.value,
        end: formEnd.value,
        tags: formTags.value.split(',').map(t => t.trim()).filter(Boolean),
      };

      if (editingTaskId) {
        // Editing existing task — validate transition
        const existing = tasks.find(t => t.id === editingTaskId);
        if (existing && taskData.status !== existing.status && !isValidTransition(existing.status, taskData.status)) {
          alert(`Invalid status transition: ${STATUS_LABELS[existing.status]} → ${STATUS_LABELS[taskData.status]}`);
          return;
        }
        updateTaskInStore(editingTaskId, taskData);
      } else {
        // Creating new task
        const id = title.toLowerCase().replace(/[^a-z0-9\s-]/g, '').replace(/\s+/g, '-').replace(/-+/g, '-').slice(0, 80);
        const now = new Date().toISOString();
        const newTask: Task = {
          id,
          ...taskData,
          order: tasks.length,
          created: now,
          updated: now,
        };
        addTask(newTask);
      }
      closeForm();
    });

    // ========================================
    // Task Deletion (T025)
    // ========================================
    const deleteOverlay = document.getElementById('delete-confirm-overlay') as HTMLElement;
    const deleteText = document.getElementById('delete-confirm-text') as HTMLElement;

    function openDeleteConfirm(taskId: string) {
      const task = tasks.find(t => t.id === taskId);
      if (!task) return;
      deletingTaskId = taskId;
      deleteText.textContent = `Are you sure you want to delete "${task.title}"?`;
      deleteOverlay.style.display = '';
    }

    document.getElementById('btn-cancel-delete')?.addEventListener('click', () => {
      deleteOverlay.style.display = 'none';
      deletingTaskId = null;
    });

    document.getElementById('btn-confirm-delete')?.addEventListener('click', () => {
      if (deletingTaskId) {
        removeTaskFromStore(deletingTaskId);
        deletingTaskId = null;
      }
      deleteOverlay.style.display = 'none';
      // Also close detail modal if open
      const detailOverlay = document.getElementById('task-detail-overlay');
      if (detailOverlay) detailOverlay.style.display = 'none';
    });

    // ========================================
    // Task Detail View
    // ========================================
    const detailOverlay = document.getElementById('task-detail-overlay') as HTMLElement;

    function openTaskDetail(taskId: string) {
      const task = tasks.find(t => t.id === taskId);
      if (!task) return;
      if ((window as any).renderTaskDetail) {
        (window as any).renderTaskDetail(task);
      }
      detailOverlay.style.display = '';
    }

    document.getElementById('task-detail-edit')?.addEventListener('click', () => {
      const content = document.getElementById('task-detail-content');
      const taskId = content?.dataset.taskId;
      if (taskId) {
        detailOverlay.style.display = 'none';
        const task = tasks.find(t => t.id === taskId);
        if (task) openEditTaskForm(task);
      }
    });

    document.getElementById('task-detail-delete')?.addEventListener('click', () => {
      const content = document.getElementById('task-detail-content');
      const taskId = content?.dataset.taskId;
      if (taskId) openDeleteConfirm(taskId);
    });

    document.getElementById('task-detail-close')?.addEventListener('click', () => {
      detailOverlay.style.display = 'none';
    });

    // ========================================
    // Inline Status/Priority Editing (T026)
    // ========================================
    document.addEventListener('change', (e) => {
      const target = e.target as HTMLSelectElement;
      if (!target.dataset.taskId || !target.dataset.field) return;

      const taskId = target.dataset.taskId;
      const field = target.dataset.field;
      const value = target.value;

      if (field === 'status') {
        const task = tasks.find(t => t.id === taskId);
        if (task && !isValidTransition(task.status, value as Status)) {
          alert(`Invalid transition: ${STATUS_LABELS[task.status]} → ${STATUS_LABELS[value as Status]}`);
          target.value = task.status; // revert
          return;
        }
        updateTaskInStore(taskId, { status: value as Status });
      } else if (field === 'priority') {
        updateTaskInStore(taskId, { priority: value as Priority });
      }
    });

    // ========================================
    // Modal Close handlers
    // ========================================
    document.querySelectorAll('.modal-overlay').forEach((overlay) => {
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          (overlay as HTMLElement).style.display = 'none';
        }
      });
    });

    document.addEventListener('planner:close-modals', () => {
      document.querySelectorAll('.modal-overlay').forEach((el) => {
        (el as HTMLElement).style.display = 'none';
      });
    });

    // ========================================
    // View Refresh (called after any data change)
    // ========================================
    function refreshViews() {
      document.dispatchEvent(new CustomEvent('planner:tasks-changed', { detail: { tasks } }));
    }

    // Click on task card -> open detail
    document.addEventListener('click', (e) => {
      const card = (e.target as HTMLElement).closest('.task-card') as HTMLElement | null;
      if (!card) return;
      if ((e.target as HTMLElement).tagName === 'SELECT') return;
      const taskId = card.dataset.taskId;
      if (taskId) openTaskDetail(taskId);
    });

    // Open task from backlog title click
    document.addEventListener('planner:open-task', ((e: CustomEvent) => {
      const taskId = e.detail.taskId;
      if (taskId) openTaskDetail(taskId);
    }) as EventListener);

    // Reorder tasks via drag-and-drop (T032)
    document.addEventListener('planner:reorder-task', ((e: CustomEvent) => {
      const { sourceId, targetId } = e.detail;
      const sourceIdx = tasks.findIndex(t => t.id === sourceId);
      const targetIdx = tasks.findIndex(t => t.id === targetId);
      if (sourceIdx < 0 || targetIdx < 0) return;
      // Move source to target position
      const [moved] = tasks.splice(sourceIdx, 1);
      tasks.splice(targetIdx, 0, moved);
      // Update order fields
      tasks.forEach((t, i) => { t.order = i; });
      refreshViews();
    }) as EventListener);

    // Kanban status change via drag-and-drop
    document.addEventListener('planner:update-task-status', ((e: CustomEvent) => {
      const { taskId, newStatus } = e.detail;
      updateTaskInStore(taskId, { status: newStatus as Status });
    }) as EventListener);

    // Expose for empty-state button
    document.getElementById('btn-empty-create')?.addEventListener('click', () => openNewTaskForm());

    // ========================================
    // Multi-Project Support (T046-T049)
    // ========================================
    interface ProjectInfo { name: string; taskCount: number; path?: string; }
    let projects: ProjectInfo[] = [];
    let activeProject = '';

    function initProjects() {
      // Load from localStorage
      const stored = localStorage.getItem('planner-projects');
      if (stored) {
        try { projects = JSON.parse(stored); } catch { projects = []; }
      }
      activeProject = localStorage.getItem('planner-active-project') || '';

      // If no projects, create a default one
      if (projects.length === 0) {
        projects = [{ name: 'default', taskCount: 0 }];
        activeProject = 'default';
        saveProjects();
      }

      // If no active project set, use first
      if (!activeProject && projects.length > 0) {
        activeProject = projects[0].name;
        localStorage.setItem('planner-active-project', activeProject);
      }

      refreshProjectList();
      loadProjectTasks();
    }

    function saveProjects() {
      localStorage.setItem('planner-projects', JSON.stringify(projects));
      localStorage.setItem('planner-active-project', activeProject);
    }

    function refreshProjectList() {
      // Update task counts
      const projectTasks = JSON.parse(localStorage.getItem(`planner-tasks-${activeProject}`) || '[]');
      const proj = projects.find(p => p.name === activeProject);
      if (proj) proj.taskCount = projectTasks.length;

      document.dispatchEvent(new CustomEvent('planner:projects-changed', {
        detail: { projects, active: activeProject }
      }));
    }

    function loadProjectTasks() {
      const stored = localStorage.getItem(`planner-tasks-${activeProject}`);
      tasks = stored ? JSON.parse(stored) : [];
      refreshViews();
    }

    function saveProjectTasks() {
      localStorage.setItem(`planner-tasks-${activeProject}`, JSON.stringify(tasks));
      refreshProjectList();
    }

    // Override refreshViews to also save
    const originalRefreshViews = refreshViews;
    refreshViews = function() {
      saveProjectTasks();
      document.dispatchEvent(new CustomEvent('planner:tasks-changed', { detail: { tasks } }));
    };

    // Switch project
    document.addEventListener('planner:switch-project', ((e: CustomEvent) => {
      activeProject = e.detail.project;
      localStorage.setItem('planner-active-project', activeProject);
      loadProjectTasks();
      refreshProjectList();
    }) as EventListener);

    // Create project
    document.addEventListener('planner:create-project', ((e: CustomEvent) => {
      const name = e.detail.name.toLowerCase().replace(/[^a-z0-9\s-]/g, '').replace(/\s+/g, '-');
      if (projects.find(p => p.name === name)) {
        alert(`Project "${name}" already exists`);
        return;
      }
      projects.push({ name, taskCount: 0 });
      activeProject = name;
      saveProjects();
      loadProjectTasks();
      refreshProjectList();
    }) as EventListener);

    // Initialize
    initProjects();
  </script>
</body>
</html>
